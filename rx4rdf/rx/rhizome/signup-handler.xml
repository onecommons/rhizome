<?xml version="1.0" encoding="UTF-8"?>
<xu:modifications xmlns:wiki="http://rx4rdf.sf.net/ns/wiki#" xmlns:wf="http://rx4rdf.sf.net/ns/racoon/xpath-ext#" xmlns:response-header="http://rx4rdf.sf.net/ns/racoon/http-response-header#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:a="http://rx4rdf.sf.net/ns/archive#" xmlns:f="http://xmlns.4suite.org/ext" xmlns:xu="http://www.xmldb.org/xupdate" version="1.0">
  <!-- validate fields
-->
  <xu:if test="not($loginname)">
    <xu:message text="login name must be specified" terminate="yes"/>
  </xu:if>
  <xu:if test="$password != $confirm-password">
    <xu:message text="password must match" terminate="yes"/>
  </xu:if>
  <!-- if we're a creating a new user check for duplicates
-->
  <xu:if test="$action='creation' and /wiki:User[wiki:login-name=$loginname]">
    <xu:message text="name already taken: please choose new login name" terminate="yes"/>
  </xu:if>
  <xu:if test="$action='creation'">
    <!-- new user     
-->
    <xu:append select="/">
      <wiki:User>
        <xu:attribute name="rdf:about">
          <xu:value-of select="concat($BASE_MODEL_URI,'users-',$loginname)"/>
        </xu:attribute>
        <wiki:login-name>
          <xu:value-of select="$loginname"/>
        </wiki:login-name>
      </wiki:User>
      <!--todo: add private security token and assign it to the user 
-->
    </xu:append>
  </xu:if>
  <!--update values   
-->
  <xu:append select="/wiki:User[wiki:login-name=$loginname]">
    <!--if the password is not equal to hash of the current password, set it
-->
    <xu:if test="not(/wiki:User[wiki:login-name=$loginname]/wiki:sha1-password) or $password != /wiki:User[wiki:login-name=$loginname]/wiki:sha1-password">
      <wiki:sha1-password>
        <xu:value-of select="f:sha-hash($password)"/>
      </wiki:sha1-password>
    </xu:if>
    <wiki:fullname>
      <xu:value-of select="$fullname"/>
    </wiki:fullname>
    <wiki:email>
      <xu:value-of select="$email"/>
    </wiki:email>
  </xu:append>
  <!--just for side-effect
-->
  <xu:if test="wf:assign-metadata('itemname', concat('users-',$loginname))"/>
</xu:modifications>

